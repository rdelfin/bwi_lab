#!/bin/bash

## Upload saved bag files from the current directory.

if [ "$1" = "-h" ] || [ "$1" = "--help" ]
then    echo "usage: $(basename $0) [option]"
        echo ""
        echo "Uploads files from the current directory to the main BWI "
        echo "server. \$HOSTNAME should be the lowest-level domain name."
        echo "By default, delete the files successfully uploaded"
        echo ""
        echo "Supports these options:"
        echo -e "\t-h [--help]\tprint this help message"
        echo -e "\t-n\tdry run, do nothing"
        echo -e "\t-p\tspecify the bag prefix (will upload nodes matching 'PREFIX_*.bag'"
        echo -e "\t-k\tkeep the files after uploading"
        exit 1
fi

# Default operations
del_opt="--remove-sent-files"
dry_run=""
prefix="bwi"

# Get parameters
while getopts 'knp:' opt; do
    case $opt in
        k)  del_opt=""       ;;
        n)  dry_run="-n"     ;;
        p)  prefix="$OPTARG" ;;
        *)  exit 1           ;;
    esac
done

suffix="_*.bag"
glob=$prefix$suffix

# Ensure the hostname is set
if [ "$HOSTNAME" == "" ]
then    echo '$HOSTNAME must be set for this operation'
        exit 9
fi

# Constants
RSYNC=/usr/bin/rsync
SERVER=nixons-head.csres.utexas.edu
TARGET_DIR=~bwilab/robot/$HOSTNAME

# See if there are bags to upload
if ! ls $glob 1> /dev/null 2>&1
then    echo "No files matching $glob found."
        exit 1
fi

# Upload the data
exec $RSYNC -avz $dry_run $del_opt -e 'ssh -p40' $glob $SERVER:$TARGET_DIR
