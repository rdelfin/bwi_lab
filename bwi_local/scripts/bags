#!/bin/bash

## Compress and upload bag files for BWI log data.

DEFAULT_DIR=~/.ros/bwi/bwi_logging

# Function to print command argument usage:
usage() {
    echo "Usage: $(basename $0) [options] PREFIX"
    echo ""
    echo "Compress and upload files matching '\$PREFIX_*.bag' to the main BWI"
    echo "server.  These bags are normally stored in '~/.ros/bwi/bwi_logging'."
    echo "Successfully uploaded compressed bags are either deleted or optionally"
    echo "saved in a subdirectory named 'kept'."
    echo ""
    echo "Options:"
    echo -e "\t-c\tcompress only, do not upload"
    echo -e "\t-d\tdirectory containing bags"
    echo -e "\t  \t (default: $DEFAULT_DIR)"
    echo -e "\t-h\tprint this message"
    echo -e "\t-k\tkeep the compressed files after uploading"
    echo -e "\t-n\tdry run, only prints bag info for the selected files"
    echo -e "\t-u\tupload only, do not compress"
}

# Default options
compress=true
dir=$DEFAULT_DIR
dry_run=false
keep=false
upload=true

# Get optional parameters
while getopts 'cd:hknu' opt; do
    case $opt in
        c)  upload=false     ;;
        d)  dir="$OPTARG"    ;;
        h)  usage; exit 0    ;;
        k)  keep=true        ;;
        n)  dry_run=true     ;;
        u)  compress=false   ;;
        *)  usage; exit 9    ;;
    esac
done

# handle PREFIX positional parameter
shift $((OPTIND-1))
if [ $# != 1 ]
then    shift
        echo "Exactly one PREFIX parameter is required:"
        usage; exit 9
fi
prefix=$1

## debug output for parameter testing:
echo -e "    compress: \t$compress"
echo -e "    dir: \t$dir"
echo -e "    dry_run: \t$dry_run"
echo -e "    keep: \t$keep"
echo -e "    prefix: \t$prefix"
echo -e "    upload: \t$upload"

suffix="_*.bag"
glob=$prefix$suffix

echo "Processing bag files in $dir."
cd $dir

# Make a subdirectory for the compressed files.
COMPRESSED="compressed"
mkdir -p $COMPRESSED

if $compress
then
        # See if there are bags to compress
        if /bin/ls $glob 1> /dev/null 2>&1
        then
                # make sure rosbag command is accessible via some ROS environment
                if ! /usr/bin/which rosbag >/dev/null
                then    source /opt/ros/indigo/setup.bash
                fi

                if $dry_run
                then    rosbag info $glob
                        # no upload done with -n
                        exit 0
                fi

                # Compress the bags
                if rosbag compress --output-dir=$COMPRESSED $glob
                then    /bin/rm -f $glob
                fi
                if [ $? != 0 ]
                then    exit $?
                fi
        else    echo "No new files matching $glob found."
        fi
fi

if ! $dry_run && $upload
then    # upload any compressed bags
        cd $COMPRESSED
        if bwilab upload -p $prefix
        then    if $keep
                then    mkdir -p ../kept
                        /bin/mv $glob ../kept
                else    /bin/rm $glob
                fi
        fi
fi

exit $?
